<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SHTESAT E F√ãMIJ√ãVE</title>

  <style>
    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #0b1f3a, #0a2540, #003a8f);
      color: #e5e7eb;
      padding: 16px 12px 88px;
    }

    .app {
      position: relative;
      background: rgba(10, 25, 47, 0.95);
      border-radius: 18px;
      padding: 22px 18px 18px;
      width: 100%;
      max-width: 520px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.50);
      overflow: hidden;
      display:none;
    }

    .header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(59,130,246,0.18);
      position: relative;
      z-index: 2;
    }

    .logo-wrap { width: 52px; height: 52px; display:flex; align-items:center; justify-content:center; }
    .logo-wrap img { width:48px; height:48px; border-radius:10px; box-shadow:0 6px 16px rgba(0,0,0,0.35); display:block; }

    .header-text h1 { margin: 0; font-size: 18px; font-weight: 650; line-height: 1.2; }
    .header-text p { margin: 2px 0 0; font-size: 12px; color: #9ca3af; line-height: 1.25; }

    .search-row { display:flex; gap:8px; margin-top:10px; position:relative; z-index:2; }
    .search-row input{
      flex:1; min-width:0;
      border-radius:10px;
      border:1px solid rgba(148,163,184,0.45);
      background: rgba(8, 20, 40, 0.85);
      padding: 12px 10px;
      color:#e5e7eb;
      outline:none;
      font-size:15px;
    }
    .search-row button{
      border-radius:10px;
      border:none;
      padding: 12px 14px;
      font-size: 15px;
      font-weight: 750;
      cursor: pointer;
      background: linear-gradient(135deg, #2563eb, #1e40af);
      color: white;
      min-width:108px;
    }
    .search-row button:disabled{ opacity:.6; cursor:not-allowed; }

    .hint { margin-top:8px; font-size:11px; color:#9ca3af; line-height:1.3; position:relative; z-index:2; }

    #result { margin-top:18px; position:relative; z-index:2; }

    .card {
      background: rgba(10, 25, 47, 0.95);
      border-radius: 14px;
      padding: 14px 14px 12px;
      border: 1px solid rgba(59,130,246,0.22);
      box-shadow: 0 10px 25px rgba(0,0,0,0.35);
    }

    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }

    .card-title { font-size: 14px; font-weight: 750; line-height:1.25; }
    .card-tag {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(37, 99, 235, 0.16);
      color: #dbeafe;
      border: 1px solid rgba(37, 99, 235, 0.35);
      flex: 0 0 auto;
      margin-top: 2px;
    }

    .card-main{
      display:grid;
      grid-template-columns: 1.1fr 1.1fr;
      gap:10px 14px;
      font-size:12px;
    }

    .field-label { font-size: 11px; color: #9ca3af; }
    .field-value { font-size: 13px; font-weight: 700; color:#e5e7eb; word-break: break-word; }

    .table-wrap{
      margin-top:12px;
      overflow:auto;
      border-radius:10px;
      -webkit-overflow-scrolling: touch;
      border:1px solid rgba(59,130,246,0.18);
    }

    table{
      border-collapse: collapse;
      width:100%;
      min-width: 920px;
      font-size: 11px;
    }

    th, td{
      border: 1px solid rgba(59,130,246,0.22);
      padding: 6px 7px;
      text-align:left;
      vertical-align: top;
    }

    th{
      background-color: rgba(7, 20, 40, 0.95);
      position: sticky;
      top:0;
      z-index:1;
    }

    .error{
      margin-top: 10px;
      color: #fecaca;
      background: rgba(127,29,29,0.6);
      border-radius: 10px;
      padding: 10px 10px;
      font-size: 12px;
      border: 1px solid rgba(248,113,113,0.5);
      line-height: 1.3;
      white-space: pre-wrap;
    }

    .loading{
      margin-top: 10px;
      font-size: 12px;
      color: #bfdbfe;
      line-height:1.3;
    }

    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:999;
      padding:18px;
    }

    .login-box{
      width:100%;
      max-width: 420px;
      background: rgba(10, 25, 47, 0.98);
      border:1px solid rgba(59,130,246,0.28);
      border-radius: 16px;
      box-shadow: 0 25px 60px rgba(0,0,0,0.55);
      padding: 18px 16px 14px;
      text-align:center;
      position:relative;
    }

    .login-title-top{
      font-size:22px;
      font-weight:900;
      letter-spacing:1px;
      margin-bottom:12px;
    }

    .login-title{ margin:0 0 6px; font-size:16px; font-weight:900; }
    .login-sub{ margin:0 0 12px; font-size:12px; color:#9ca3af; line-height:1.3; }

    .login-row{ display:grid; gap:10px; margin-top:10px; }
    .login-row input{
      width:100%;
      border-radius:10px;
      border:1px solid rgba(148,163,184,0.45);
      background: rgba(8, 20, 40, 0.85);
      padding: 12px 10px;
      color:#e5e7eb;
      outline:none;
      font-size: 15px;
    }

    .btn-login{
      border-radius:10px;
      border:none;
      padding: 12px 14px;
      font-size: 15px;
      font-weight: 900;
      cursor:pointer;
      background: linear-gradient(135deg,#2563eb,#1e40af);
      color:white;
      width:100%;
      margin-top:12px;
    }

    .login-error{
      margin-top:10px;
      color:#fecaca;
      background: rgba(127,29,29,0.6);
      border-radius:10px;
      padding:10px 10px;
      font-size:12px;
      border:1px solid rgba(248,113,113,0.5);
      display:none;
      line-height:1.3;
      white-space: pre-wrap;
    }

    .footer{
      position: fixed;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      text-align:center;
      font-size: 12px;
      color:#9ca3af;
      z-index:20;
      pointer-events:none;
      width: min(520px, calc(100% - 24px));
    }
    .footer strong{
      display:block;
      margin-top:4px;
      font-size:14px;
      color:#e5e7eb;
      font-weight: 650;
    }
    .footer small{
      display:block;
      margin-top:8px;
      font-size:11px;
      color:#94a3b8;
      line-height:1.25;
    }

    @media (max-width:520px){
      .search-row{flex-direction:column;}
      .search-row button{width:100%;}
      table{min-width: 860px;}
    }

    @media (max-width:380px){
      .card-main{grid-template-columns:1fr;}
    }
  </style>
</head>

<body>

  <!-- LOGIN -->
  <div class="overlay" id="loginOverlay">
    <div class="login-box">
      <div class="login-title-top">SHTESAT E F√ãMIJ√ãVE</div>
      <h2 class="login-title">Akses i kufizuar</h2>
      <p class="login-sub">Shkruaj kredencialet p√´r t√´ vazhduar.</p>

      <div class="login-row">
        <input id="user" type="text" placeholder="Username" autocomplete="off" />
        <input id="pass" type="password" placeholder="Password" autocomplete="off"
               onkeydown="if(event.key==='Enter') doLogin()" />
      </div>

      <button type="button" class="btn-login" onclick="doLogin()">üîê Hyr</button>
      <div class="loading" id="loginLoading" style="display:none;">Duke p√´rgatitur t√´ dh√´nat...</div>
      <div class="login-error" id="loginErr"></div>
    </div>
  </div>

  <!-- APP -->
  <div class="app" id="appRoot">
    <div class="header">
      <div class="logo-wrap">
        <img src="https://upload.wikimedia.org/wikipedia/commons/1/1f/Flag_of_Kosovo.svg" alt="Flamuri i Kosov√´s" />
      </div>
      <div class="header-text">
        <h1>Republika e Kosov√´s</h1>
        <p>Sistem k√´rkimi (Sheet2) sipas Nr. Personal Aplikanti</p>
      </div>
    </div>

    <div class="search-row">
      <input id="idInput" type="text" placeholder="Shkruaj Nr. Personal Aplikanti (kolona B)" autocomplete="off" />
      <button id="searchBtn" onclick="doSearch()" disabled>üîç K√´rko</button>
    </div>

    <div class="hint" id="hintText">
      Pas login-it t√´ dh√´nat ngarkohen automatikisht. Pastaj k√´rkimi del menj√´her√´.
    </div>

    <div id="result"></div>
  </div>

  <!-- Footer fixed -->
  <div class="footer">
    Zhvilluar dhe Sinkronizuar
    <strong>Edmond Murati</strong>
    <small>
      T√´ dh√´nat mund t√´ mos sinkronizohen var√´sisht nga Government Gateway
      si dhe afatet e procesimit
    </small>
  </div>

<script>
  const AUTH_USER = "shtesat";
  const AUTH_PASS = "12345";

  const CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vTsUVIHAqV1UKxgzLzx_GVVv5GNfMPvJoKFDZb7IGRxtZpSmzG1Iqv6eQdxjijoogaYT_mAqaYHkOgU/pub?gid=2091668904&single=true&output=csv";

  let header = [];
  let data = [];
  let preloaded = false;
  let dataPromise = null;

  function esc(s) {
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // CSV parser (quotes safe)
  function parseCSV(text) {
    const rows = [];
    let row = [];
    let field = "";
    let i = 0;
    let inQuotes = false;

    while (i < text.length) {
      const c = text[i];

      if (inQuotes) {
        if (c === '"') {
          if (text[i + 1] === '"') { field += '"'; i += 2; continue; }
          inQuotes = false; i++; continue;
        }
        field += c; i++; continue;
      }

      if (c === '"') { inQuotes = true; i++; continue; }
      if (c === ",") { row.push(field); field = ""; i++; continue; }
      if (c === "\r") { i++; continue; }
      if (c === "\n") { row.push(field); rows.push(row); row = []; field = ""; i++; continue; }

      field += c; i++;
    }

    row.push(field);
    rows.push(row);
    return rows.filter(r => r.some(x => String(x ?? "").trim() !== ""));
  }

  function toNum(v) {
    let s = String(v ?? "").trim();
    if (!s) return 0;

    s = s.replace(/\s+/g, "");
    // normalizim p√´r 1.234,56 ose 1234,56
    if (s.includes(",") && s.includes(".")) s = s.replace(/\./g, "").replace(",", ".");
    else if (s.includes(",") && !s.includes(".")) s = s.replace(",", ".");

    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  }

  function formatMoney(n) {
    try {
      return new Intl.NumberFormat("sq-AL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n);
    } catch {
      return (Math.round(n * 100) / 100).toFixed(2);
    }
  }

  async function loadData() {
    if (dataPromise) return dataPromise;

    dataPromise = (async () => {
      const r = await fetch(CSV_URL + "&cb=" + Date.now(), { cache: "no-store" });
      if (!r.ok) throw new Error("Nuk u lexua CSV. Status: " + r.status);

      const t = await r.text();
      const rows = parseCSV(t);
      if (!rows.length) throw new Error("CSV doli bosh.");

      header = rows[0] || [];
      data = rows.slice(1);
      preloaded = true;
    })();

    return dataPromise;
  }

  window.doLogin = async function () {
    const u = (document.getElementById("user").value || "").trim();
    const p = (document.getElementById("pass").value || "");

    const err = document.getElementById("loginErr");
    const loading = document.getElementById("loginLoading");
    const searchBtn = document.getElementById("searchBtn");

    err.style.display = "none";
    err.textContent = "";

    if (u !== AUTH_USER || p !== AUTH_PASS) {
      err.style.display = "block";
      err.textContent = "Username ose Password gabim.";
      return;
    }

    // hap app menj√´her√´
    document.getElementById("loginOverlay").style.display = "none";
    document.getElementById("appRoot").style.display = "block";
    document.getElementById("result").innerHTML = "<div class='loading'>Duke p√´rgatitur t√´ dh√´nat...</div>";

    // preload real
    loading.style.display = "block";
    searchBtn.disabled = true;

    try {
      await loadData();
      document.getElementById("result").innerHTML = "";
      searchBtn.disabled = false;
      document.getElementById("idInput").focus();
      document.getElementById("hintText").textContent =
        "T√´ dh√´nat u ngarkuan. Shkruaj Nr. Personal Aplikanti (kolona B) dhe shtyp Enter ose ‚ÄúK√´rko‚Äù.";
    } catch (e) {
      document.getElementById("result").innerHTML =
        "<div class='error'>Gabim n√´ lexim: " + esc(e.message) + "</div>";
      searchBtn.disabled = false; // lejo retry
    } finally {
      loading.style.display = "none";
    }
  };

  function findAllById(id) {
    id = String(id ?? "").trim();
    const out = [];
    for (const r of data) {
      if ((r[1] || "").trim() === id) out.push(r); // B = index 1
    }
    return out;
  }

  function renderRows(rows, searchedId) {
    const result = document.getElementById("result");

    if (!rows.length) {
      result.innerHTML = "<div class='error'>Nuk u gjet asnj√´ rresht p√´r k√´t√´ ID.</div>";
      return;
    }

    // TOTAL vet√´m nga kolona L (Shuma) = index 11
    let total = 0;
    for (const r of rows) total += toNum(r[11]);

    // disa fusha p√´r ‚Äúsummary‚Äù (merren nga rreshti i par√´)
    const first = rows[0];
    const aplikanti = first[2] ?? "";
    const shumaTotale = first[3] ?? ""; // vet√´m shfaqet
    const banka = first[4] ?? "";
    const bban = first[5] ?? "";
    const nrAplikimit = first[6] ?? "";
    const dataAplikimit = first[7] ?? "";

    let html = "<div class='card'>";

    html += "<div class='card-header'>"
          +   "<div class='card-title'>Rezultatet p√´r ID: <strong>" + esc(searchedId) + "</strong></div>"
          +   "<div class='card-tag'>TOTAL (Shuma): " + esc(formatMoney(total)) + "</div>"
          + "</div>";

    html += "<div class='card-main'>"
          +   "<div><div class='field-label'>Aplikanti</div><div class='field-value'>" + esc(aplikanti || "-") + "</div></div>"
          +   "<div><div class='field-label'>Shuma Totale</div><div class='field-value'>" + esc(shumaTotale || "-") + "</div></div>"
          +   "<div><div class='field-label'>Banka</div><div class='field-value'>" + esc(banka || "-") + "</div></div>"
          +   "<div><div class='field-label'>BBAN</div><div class='field-value'>" + esc(bban || "-") + "</div></div>"
          +   "<div><div class='field-label'>Nr. Aplikimit</div><div class='field-value'>" + esc(nrAplikimit || "-") + "</div></div>"
          +   "<div><div class='field-label'>Data Aplikimit</div><div class='field-value'>" + esc(dataAplikimit || "-") + "</div></div>"
          + "</div>";

    // ‚úÖ KJO √ãSHT√ã TABELA E PLOT√ã (q√´ ke th√´n√´ u hoq)
    html += "<div class='table-wrap'><table><thead><tr>";
    for (let i = 0; i < header.length; i++) {
      const h = String(header[i] ?? ("Kolona " + (i+1))).replace(/\r?\n/g, " ").replace(/\s+/g, " ").trim();
      html += "<th>" + esc(h) + "</th>";
    }
    html += "</tr></thead><tbody>";

    for (const r of rows) {
      html += "<tr>";
      for (let i = 0; i < header.length; i++) {
        html += "<td>" + esc(r[i] ?? "") + "</td>";
      }
      html += "</tr>";
    }

    html += "</tbody></table></div></div>";

    result.innerHTML = html;
  }

  window.doSearch = async function () {
    const id = document.getElementById("idInput").value.trim();
    if (!id) return;

    if (!preloaded) {
      document.getElementById("result").innerHTML = "<div class='loading'>Duke pritur ngarkimin e t√´ dh√´nave...</div>";
      try { await loadData(); } catch (e) {
        document.getElementById("result").innerHTML = "<div class='error'>Gabim n√´ lexim: " + esc(e.message) + "</div>";
        return;
      }
    }

    const rows = findAllById(id);
    renderRows(rows, id);
  };

  document.getElementById("idInput").addEventListener("keydown", (e) => {
    if (e.key === "Enter") doSearch();
  });
</script>

</body>
</html>
